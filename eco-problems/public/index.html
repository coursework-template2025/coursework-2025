<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Экологические проблемы Кыргызстана</title>
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* Стиль модального окна с картой */
    #mapModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
    }
    #mapContainer {
      position: relative;
      width: 90%;
      height: 80vh;
      margin: 5vh auto;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
    }
    #map {
      height: 100%;
      width: 100%;
    }
    .close-map {
      position: absolute;
      top: 10px;
      right: 15px;
      background: #f44336;
      color: white;
      border: none;
      font-size: 20px;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 6px;
      z-index: 1000;
    }
    .show-map-btn {
      padding: 10px 20px;
      font-size: 18px;
      background-color: #4caf50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    .show-map-btn:hover {
      background-color: #388e3c;
    }

    /* Регистрация и вход - кнопки */
    header .auth-buttons {
      margin-top: 10px;
      text-align: right;
    }
    header .auth-buttons button {
      background: #4caf50;
      border: none;
      color: white;
      padding: 8px 14px;
      margin-left: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.3s;
    }
    header .auth-buttons button:hover {
      background: #388e3c;
    }

    /* Модальные окна регистрации и входа */
    .modal {
      position: fixed;
      z-index: 10000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      border-radius: 8px;
      padding: 25px 30px;
      width: 320px;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      font-family: 'Roboto', sans-serif;
    }
    .modal-content h2 {
      margin-top: 0;
      color: #4caf50;
      font-weight: 700;
    }
    .modal-content input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
    }
    .modal-content button {
      width: 100%;
      background: #4caf50;
      border: none;
      color: white;
      font-weight: 700;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
      font-size: 16px;
    }
    .modal-content button:hover {
      background: #388e3c;
    }
    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
      color: #555;
    }
    .error {
      color: red;
      font-size: 13px;
      margin-top: -12px;
      margin-bottom: 10px;
      min-height: 18px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <section style="text-align: center; margin: 40px 0;">
    <button class="show-map-btn" onclick="openMap()">Показать интерактивную карту</button>
  </section>
  <header>
    <div class="container">
      <h1>Экологические проблемы Кыргызстана</h1>
      <nav>
        <ul>
          <li><a href="#">Главная</a></li>
          <li><a href="#problems">Проблемы</a></li>
          <li><a href="#add-problem">Добавить</a></li>
        </ul>
      </nav>
      <div class="auth-buttons">
        <button id="openRegisterBtn">Регистрация</button>
        <button id="openLoginBtn">Вход</button>
      </div>
    </div>
  </header>

  <section class="hero">
    <div class="container">
      <h2>Защитим природу Кыргызстана вместе!</h2>
      <p>Проблемы окружающей среды требуют немедленного внимания. Ознакомьтесь с текущими вызовами и внесите свой вклад.</p>
      <img src="images/kyrgyzstan.jpg.jfif" alt="Кыргызстан природа" />
    </div>
  </section>

  <section id="problems" class="container">
  <h2>Список проблем</h2>
  
  <select id="categoryFilter">
    <option value="all">Все категории</option>
    <option value="Воздух">Воздух</option>
    <option value="Леса">Леса</option>
    <option value="Отходы">Отходы</option>
    <option value="Вода">Вода</option>
    <option value="Земля">Земля</option>
    <option value="Флора и фауна">Флора и фауна</option>
  </select>
  
  <input type="text" id="search" placeholder="Поиск по названию..." />
  <div id="problemsList" class="card-list"></div>
</section>


  <section id="add-problem" class="container">
    <h2>Добавить проблему</h2>
    <form id="problemForm">
      <input type="text" id="title" placeholder="Название" required />
      <textarea id="description" placeholder="Описание" required></textarea>
      <input type="text" id="location" placeholder="Локация (город/регион)" required />
      <button type="submit">Сохранить</button>
    </form>
  </section>

  <footer>
    <div class="container">
      <p>© 2025 Экология Кыргызстана. Все права защищены.</p>
    </div>
  </footer>

  <!-- Модальное окно карты -->
  <div id="mapModal">
    <div id="mapContainer">
      <button class="close-map" onclick="closeMap()">✖</button>
      <div id="map"></div>
    </div>
  </div>

  <!-- Модалка Регистрации -->
  <div id="registerModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeRegister">&times;</span>
      <h2>Регистрация</h2>
      <form id="registerForm">
        <input type="text" name="username" placeholder="Имя пользователя" required />
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Пароль (мин. 6 символов)" required minlength="6" />
        <button type="submit">Зарегистрироваться</button>
        <div id="registerError" class="error"></div>
      </form>
    </div>
  </div>

  <!-- Модалка Входа -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <span class="close" id="closeLogin">&times;</span>
      <h2>Вход</h2>
      <form id="loginForm">
        <input type="email" name="email" placeholder="Email" required />
        <input type="password" name="password" placeholder="Пароль" required />
        <button type="submit">Войти</button>
        <div id="loginError" class="error"></div>
      </form>
    </div>
  </div>

  <script>
    // Карта и регионы (твой существующий код)
    const regions = [
      {
        name: "Бишкек",
        lat: 42.8746,
        lng: 74.5698,
        problems: "Загрязнение воздуха, стихийные свалки"
      },
      {
        name: "Чуйская область",
        lat: 42.8355,
        lng: 75.2995,
        problems: "Загрязнение почвы, мусор"
      },
      {
        name: "Ошская область",
        lat: 40.5134,
        lng: 72.8161,
        problems: "Вырубка лесов, отходы"
      },
      {
        name: "Джалал-Абадская область",
        lat: 40.9333,
        lng: 73.0,
        problems: "Загрязнение рек, свалки"
      },
      {
        name: "Баткенская область",
        lat: 39.9376,
        lng: 70.8295,
        problems: "Проблемы с водой, браконьерство"
      },
      {
        name: "Иссык-Кульская область",
        lat: 42.1856,
        lng: 77.5615,
        problems: "Загрязнение озера, береговая линия"
      },
      {
        name: "Нарынская область",
        lat: 41.4275,
        lng: 75.9911,
        problems: "Загрязнение пастбищ, отходы скота"
      },
      {
        name: "Таласская область",
        lat: 42.5228,
        lng: 72.2426,
        problems: "Сельхозотходы, нехватка утилизации"
      }
    ];

    let map = null; // глобальная переменная

    function openMap() {
      document.getElementById("mapModal").style.display = "block";

      setTimeout(() => {
        // Удаляем старую карту, если она была
        if (map) {
          map.remove();
          map = null;
        }

        // Очищаем содержимое контейнера
        document.getElementById("map").innerHTML = "";

        // Создаём новую карту
        map = L.map("map").setView([41.5, 75], 6.5);

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Добавляем маркеры
        regions.forEach((region) => {
          L.marker([region.lat, region.lng])
            .addTo(map)
            .bindPopup(`
              <div class="map-popup">
                <strong>${region.name}</strong><br>
                ${region.problems
                  .split(", ")
                  .map(p => `🌿 ${p}`)
                  .join("<br>")}
              </div>
            `);
        });
      }, 300); // Ждём, пока модалка отобразится
    }

    function closeMap() {
      document.getElementById("mapModal").style.display = "none";
    }

    // Открытие/закрытие модалок Регистрации и Входа
    const registerModal = document.getElementById('registerModal');
    const loginModal = document.getElementById('loginModal');
    document.getElementById('openRegisterBtn').onclick = () => {
      registerModal.style.display = 'flex';
      loginModal.style.display = 'none';
    };
    document.getElementById('openLoginBtn').onclick = () => {
      loginModal.style.display = 'flex';
      registerModal.style.display = 'none';
    };
    document.getElementById('closeRegister').onclick = () => {
      registerModal.style.display = 'none';
    };
    document.getElementById('closeLogin').onclick = () => {
      loginModal.style.display = 'none';
    };
    window.onclick = (event) => {
      if(event.target === registerModal) registerModal.style.display = 'none';
      if(event.target === loginModal) loginModal.style.display = 'none';
      if(event.target === document.getElementById('mapModal')) closeMap();
    };

    // Обработка регистрации (пример, отправка на /api/register)
    document.getElementById('registerForm').onsubmit = async (e) => {
      e.preventDefault();
      const form = e.target;
      const username = form.username.value.trim();
      const email = form.email.value.trim();
      const password = form.password.value;

      const errorDiv = document.getElementById('registerError');
      errorDiv.textContent = '';

      if (password.length < 6) {
        errorDiv.textContent = 'Пароль должен быть не менее 6 символов.';
        return;
      }

      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, email, password })
        });
        if (!response.ok) {
          const result = await response.json();
          errorDiv.textContent = result.message || 'Ошибка регистрации';
        } else {
          alert('Регистрация прошла успешно! Теперь войдите.');
          form.reset();
          registerModal.style.display = 'none';
          loginModal.style.display = 'flex';
        }
      } catch (err) {
        errorDiv.textContent = 'Ошибка сети или сервера.';
      }
    };

    // Обработка входа (пример, отправка на /api/login)
    document.getElementById('loginForm').onsubmit = async (e) => {
      e.preventDefault();
      const form = e.target;
      const email = form.email.value.trim();
      const password = form.password.value;

      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = '';

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });
        if (!response.ok) {
          const result = await response.json();
          errorDiv.textContent = result.message || 'Неверный email или пароль.';
        } else {
          alert('Вход выполнен успешно!');
          form.reset();
          loginModal.style.display = 'none';
          // Тут можно обновить UI для вошедшего пользователя
        }
      } catch (err) {
        errorDiv.textContent = 'Ошибка сети или сервера.';
      }
    };

    // Логика поиска и отображения проблем (пример)
    const problemsList = document.getElementById('problemsList');
    const searchInput = document.getElementById('search');

    // Массив проблем — тут можно подключить реальный источник данных
    let problems = [
  { 
    title: 'Загрязнение воздуха в Бишкеке', 
    description: 'Высокий уровень выбросов в атмосферу от транспорта и предприятий.',
    category: 'Воздух'
  },
  { 
    title: 'Вырубка лесов в Ошской области', 
    description: 'Незаконные вырубки и деградация лесных массивов.',
    category: 'Леса'
  },
  { 
    title: 'Свалки отходов в Чуйской области', 
    description: 'Несанкционированные свалки приводят к загрязнению почвы и воды.',
    category: 'Отходы'
  },
  { 
    title: 'Загрязнение озера Иссык-Куль', 
    description: 'Рост уровня загрязнения береговой линии и водоёма.',
    category: 'Вода'
  },
  { 
    title: 'Деградация пастбищ в Нарынской области', 
    description: 'Перенаселение скота и неправильное использование земель.',
    category: 'Земля'
  },
  { 
    title: 'Недостаток утилизации сельхозотходов в Таласской области', 
    description: 'Проблемы с переработкой и утилизацией отходов с полей.',
    category: 'Отходы'
  },
  { 
    title: 'Загрязнение рек в Джалал-Абадской области', 
    description: 'Промышленные и бытовые стоки ухудшают качество воды.',
    category: 'Вода'
  },
  { 
    title: 'Проблемы с водоснабжением в Баткенской области', 
    description: 'Ограниченный доступ к чистой питьевой воде для населения.',
    category: 'Вода'
  },
  { 
    title: 'Браконьерство и уничтожение флоры и фауны', 
    description: 'Незаконный отлов и вырубка угрожают экосистемам региона.',
    category: 'Флора и фауна'
  },
  { 
    title: 'Пыльные бури и эрозия почвы', 
    description: 'Возрастающие природные явления, ухудшающие состояние земель.',
    category: 'Земля'
  }
];


    function renderProblems(list) {
      problemsList.innerHTML = '';
      if(list.length === 0) {
        problemsList.innerHTML = '<p>Проблемы не найдены.</p>';
        return;
      }
      list.forEach(item => {
        const card = document.createElement('div');
        card.classList.add('card');
        card.style.border = '1px solid #ccc';
        card.style.borderRadius = '8px';
        card.style.padding = '15px';
        card.style.marginBottom = '12px';
        card.innerHTML = `<h3>${item.title}</h3><p>${item.description}</p>`;
        problemsList.appendChild(card);
      });
    }

   const categoryFilter = document.getElementById('categoryFilter');

function filterProblems() {
  const query = searchInput.value.toLowerCase();
  const category = categoryFilter.value;

  let filtered = problems;

  if (category !== 'all') {
    filtered = filtered.filter(p => p.category === category);
  }

  if (query) {
    filtered = filtered.filter(p => p.title.toLowerCase().includes(query));
  }

  renderProblems(filtered);
}

searchInput.addEventListener('input', filterProblems);
categoryFilter.addEventListener('change', filterProblems);

// Начальный рендер проблем (оставляем как есть)
renderProblems(problems);

    // Начальный рендер проблем
    renderProblems(problems);

    // Обработка формы добавления новой проблемы
    document.getElementById('problemForm').onsubmit = e => {
      e.preventDefault();
      const title = document.getElementById('title').value.trim();
      const description = document.getElementById('description').value.trim();
      const location = document.getElementById('location').value.trim();

      if (!title || !description || !location) {
        alert('Пожалуйста, заполните все поля.');
        return;
      }

      problems.push({ title: `${title} (${location})`, description });
      renderProblems(problems);
      e.target.reset();
      alert('Проблема успешно добавлена!');
    };
  </script>

  <!-- Подключаем Leaflet.js ПОСЛЕ определения всех функций, чтобы L был доступен -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

</body>
</html>
