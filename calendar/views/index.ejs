<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Календарь</title>
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/style.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body class="bg-gray-100 p-6">
    
    <% if (!user) { %>
    <div class="flex flex-col items-center justify-center h-screen text-center">
      <div class="bg-white shadow-lg rounded-lg p-8 max-w-md">
        <h2 class="text-2xl font-bold text-red-600 mb-4">Доступ запрещён</h2>
        <p class="text-gray-700 mb-6">
          Пожалуйста, войдите в систему, чтобы просматривать календарь.
        </p>
        <a
          href="/login"
          class="inline-block bg-blue-500 hover:bg-blue-600 text-white font-semibold px-6 py-2 rounded transition duration-200"
        >
          Войти
        </a>
      </div>
    </div>
    <% } else { %>
    <div class="flex justify-between items-center mb-6">
      <h1 class="text-3xl font-bold">Календарь</h1>
      <div>
        <span class="mr-4">Привет, <%= user.username %></span>
        <a href="/logout" class="text-red-500 underline">Выйти</a>
      </div>
    </div>

    <!-- Навигация по месяцам -->
    <div class="flex justify-between items-center mb-4">
      <button
        onclick="navigateMonth(-1)"
        class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded"
      >
        ← Назад
      </button>
      <h2 class="text-xl font-bold">
        <%= currentMonthName %> <%= currentYear %>
      </h2>
      <button
        onclick="navigateMonth(1)"
        class="bg-gray-300 hover:bg-gray-400 text-black px-4 py-2 rounded"
      >
        Вперёд →
      </button>
    </div>

    <!-- Дни недели -->
    <div
      class="grid grid-cols-7 gap-2 text-center font-bold text-gray-600 mb-2"
    >
      <div>Пн</div>
      <div>Вт</div>
      <div>Ср</div>
      <div>Чт</div>
      <div>Пт</div>
      <div class="text-red-500">Сб</div>
      <div class="text-red-500">Вс</div>
    </div>

    <!-- Календарь -->
    <div class="grid grid-cols-7 gap-2 mb-6" id="calendar">
      <% const daysInMonth = new Date(currentYear, currentMonthIndex + 1,
      0).getDate(); const firstDay = new Date(currentYear, currentMonthIndex,
      1).getDay(); const offset = firstDay === 0 ? 6 : firstDay - 1; for (let i
      = 0; i < offset; i++) { %>
      <div></div>
      <% } %> <% for (let i = 1; i <= daysInMonth; i++) { const date = new
      Date(currentYear, currentMonthIndex, i); const weekday = date.getDay();
      const isWeekend = weekday === 0 || weekday === 6; const isToday = i ===
      currentDay && currentMonthIndex === new Date().getMonth() && currentYear
      === new Date().getFullYear(); %>
      <div
        class="p-2 rounded shadow text-center <%= isToday ? 'bg-blue-200' : 'bg-white' %> <%= isWeekend ? 'text-red-500' : '' %>"
        id="day-<%= i %>"
      >
        <div class="font-bold"><%= i %></div>
        <% events.forEach(e => { const eventDate = new Date(e.date); const
        eventDay = eventDate.getDate(); const eventMonth = eventDate.getMonth();
        const eventYear = eventDate.getFullYear(); if (eventDay === i &&
        eventMonth === currentMonthIndex && eventYear === currentYear) { %>
        <div class="text-xs mt-1 bg-blue-200 p-1 rounded"><%= e.title %></div>
        <% }}); %>
      </div>
      <% } %>
    </div>

    <!-- Форма для добавления события -->
    <div class="mt-6">
      <h2 class="text-2xl mb-4">Добавить событие</h2>
      <form id="eventForm" class="flex flex-wrap gap-2">
        <input
          type="text"
          id="title"
          name="title"
          placeholder="Название события"
          class="p-2 border rounded w-full sm:w-auto flex-grow"
          required
        />
        <input
          type="date"
          id="date"
          name="date"
          class="p-2 border rounded w-full sm:w-auto"
          required
        />
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded">
          Добавить
        </button>
      </form>
      <div id="errorMessage" class="text-red-500 mt-4 hidden"></div>
    </div>

    <!-- Скрипты -->
    <script>
      let currentMonth = <%= currentMonthIndex %>;
      let currentYear = <%= currentYear %>;

      function navigateMonth(direction) {
        currentMonth += direction;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        } else if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        window.location.href = `/?month=${currentMonth}&year=${currentYear}`;
      }

      $(document).ready(function () {
        $("#eventForm").on("submit", function (e) {
          e.preventDefault();
          const title = $("#title").val();
          const date = $("#date").val();
          $("#errorMessage").addClass("hidden").text("");

          if (!title || !date) {
            $("#errorMessage").removeClass("hidden").text("Все поля обязательны.");
            return;
          }

          $.ajax({
            url: "/api/events",
            method: "POST",
            data: { title, date },
            success: function (response) {
              if (response.status === "ok") {
                const eventDay = new Date(date).getDate();
                const eventHtml = `
                  <div class="text-xs mt-1 bg-blue-200 p-1 rounded">
                    ${title}
                  </div>`;
                $(`#day-${eventDay}`).append(eventHtml);
                $("#title").val("");
                $("#date").val("");
              }
            },
            error: function () {
              $("#errorMessage")
                .removeClass("hidden")
                .text("Ошибка при добавлении события.");
            },
          });
        });
      });
    </script>
    <% } %>
  </body>
</html>
